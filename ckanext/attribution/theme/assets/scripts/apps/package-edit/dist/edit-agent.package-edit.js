(window.webpackJsonppackage_edit=window.webpackJsonppackage_edit||[]).push([[2],{80:function(t,e,i){"use strict";i.r(e);var n=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"agent-edit-block agent-detail",class:"agent-"+t.edits.agent_type.toLowerCase()},[i("div",{staticClass:"agent-header"},[i("AgentTypeField",{model:{value:t.edits.agent_type,callback:function(e){t.$set(t.edits,"agent_type",e)},expression:"edits.agent_type"}}),t._v(" "),i("span",{staticClass:"display-name"},[i("em",[t._v(t._s(t.displayName))])]),t._v(" "),i("div",{staticClass:"edit-icons"},[t.edits.external_id?i("span",{staticClass:"edit-icon",attrs:{title:"Download contributor details from external source"},on:{click:t.syncAgent}},[i("i",{staticClass:"fas",class:t.syncing?"fa-spinner fa-spin":"fa-arrow-alt-circle-down"})]):t._e(),t._v(" "),t.canEdit&&!t.contributor.meta.is_temporary?i("span",{staticClass:"edit-icon",attrs:{title:"Edit"},on:{click:t.stopEdit}},[i("i",{staticClass:"fas fa-edit"})]):t._e(),t._v(" "),t.contributor.meta.is_temporary?t._e():i("span",{staticClass:"edit-icon",attrs:{title:"Remove this contributor"},on:{click:function(e){return t.eventBus.$emit(t.events.removeContributor,t.contributorId)}}},[i("i",{staticClass:"fas fa-minus-circle"})])])],1),t._v(" "),i("div",{staticClass:"agent-id-edit attribution-row"},[i("select-field",{class:["wrap-small"],attrs:{options:Object.entries(t.controlledLists.agentIdSchemes),"opt-label":function(t){return t[1].label},"opt-value":function(t){return t[0]}},model:{value:t.edits.external_id_scheme,callback:function(e){t.$set(t.edits,"external_id_scheme",e)},expression:"edits.external_id_scheme"}},[t._v("\n            External ID scheme\n        ")]),t._v(" "),i("ValidatedField",{ref:"externalId",class:["wrap-small"],attrs:{validator:t.validateExternalId,placeholder:t.controlledLists.agentIdSchemes[t.edits.external_id_scheme].label},model:{value:t.edits.external_id,callback:function(e){t.$set(t.edits,"external_id",e)},expression:"edits.external_id"}},[i("i",{class:t.controlledLists.agentIdSchemes[t.edits.external_id_scheme].fa_icon}),t._v("\n            "+t._s(t.controlledLists.agentIdSchemes[t.edits.external_id_scheme].label)+"\n        ")])],1),t._v(" "),i("div",{staticClass:"expand-bar",attrs:{title:"Expand"},on:{click:function(e){t.expand=!t.expand}}},[i("i",{staticClass:"fas",class:t.expand?"fa-caret-up":"fa-caret-down"}),t._v(" "),i("small",[t._v("Show all edit options")]),t._v(" "),i("i",{staticClass:"fas",class:t.expand?"fa-caret-up":"fa-caret-down"})]),t._v(" "),t.expand?[i("div",{staticClass:"agent-name-edit attribution-row"},["person"===t.edits.agent_type?[i("text-field",{attrs:{cls:["wrap-small"]},model:{value:t.edits.family_name,callback:function(e){t.$set(t.edits,"family_name",e)},expression:"edits.family_name"}},[t._v("\n                    Family name\n                ")]),t._v(" "),i("text-field",{attrs:{cls:["wrap-small"]},model:{value:t.edits.given_names,callback:function(e){t.$set(t.edits,"given_names",e)},expression:"edits.given_names"}},[t._v("\n                    Given name(s)\n                ")]),t._v(" "),t._l(t.idGen,(function(e){return i("div",{staticClass:"attribution-field one-line"},[i("label",{attrs:{for:e}},[t._v("\n                        Given names first\n                    ")]),t._v(" "),i("input",{directives:[{name:"model",rawName:"v-model",value:t.edits.given_names_first,expression:"edits.given_names_first"}],attrs:{id:e,type:"checkbox"},domProps:{checked:Array.isArray(t.edits.given_names_first)?t._i(t.edits.given_names_first,null)>-1:t.edits.given_names_first},on:{change:function(e){var i=t.edits.given_names_first,n=e.target,a=!!n.checked;if(Array.isArray(i)){var s=t._i(i,null);n.checked?s<0&&t.$set(t.edits,"given_names_first",i.concat([null])):s>-1&&t.$set(t.edits,"given_names_first",i.slice(0,s).concat(i.slice(s+1)))}else t.$set(t.edits,"given_names_first",a)}}})])})),t._v(" "),i("help-tooltip",[t._v("\n                    Does this person's culture or language typically place given or family\n                    names first? (this does not affect sorting)\n                ")])]:t._e(),t._v(" "),"person"!==t.edits.agent_type?[i("text-field",{model:{value:t.edits.name,callback:function(e){t.$set(t.edits,"name",e)},expression:"edits.name"}},[t._v("\n                    Name\n                ")]),t._v(" "),i("text-field",{model:{value:t.edits.location,callback:function(e){t.$set(t.edits,"location",e)},expression:"edits.location"}},[t._v("\n                    Location\n                ")])]:t._e()],2),t._v(" "),i("div",{staticClass:"agent-user-edit attribution-row"},[i("autocomplete-field",{attrs:{options:t.userOptions,label:"Associated user","item-id":"agent-user-"+t.contributorId},on:{typing:t.updateUserOptions},model:{value:t.edits.user_id,callback:function(e){t.$set(t.edits,"user_id",e)},expression:"edits.user_id"}}),t._v(" "),i("help-tooltip",[t._v("\n                If this contributor has a user account registered on the portal, associate it here\n            ")])],1),t._v(" "),i("div",{staticClass:"agent-affiliations-edit attribution-row"},[i("autocomplete-list",{attrs:{options:t.affiliationOptions,label:"Add affiliation","item-id":"agent-affiliation-"+t.contributorId},on:{typing:t.updateAffiliationOptions},model:{value:t.affiliations,callback:function(e){t.affiliations=e},expression:"affiliations"}}),t._v(" "),i("help-tooltip",[t._v("\n                For affiliations that are associated with "),i("em",[t._v("this package only")]),t._v(". Only includes contributors\n                that have already been added to this page.\n            ")])],1)]:t._e(),t._v(" "),t.contributor.meta.is_temporary?t._e():i("div",{staticClass:"attribution-save"},[i("span",{staticClass:"btn",class:t.isValid?"btn-primary":"btn-disabled",on:{click:t.saveChanges}},[i("i",{staticClass:"fas fa-save"}),t._v("\n            Save changes\n        ")]),t._v(" "),i("span",{staticClass:"btn btn-primary",on:{click:t.stopEdit}},[i("i",{staticClass:"fas fa-times"}),t._v("\n            Cancel\n        ")])])],2)};n._withStripped=!0;var a=i(4),s=i(6),r=i(33),o=i(20),l=i(0),c=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"agent-type-edit",class:t.classes},t._l(t.options,(function(e,n){return i("span",{staticClass:"agent-type-option"},[i("input",{attrs:{type:"radio",id:t.optionId(n)},domProps:{value:n,checked:t.value===n},on:{change:t.setValue}}),t._v(" "),i("label",{attrs:{for:t.optionId(n),title:n}},[i("i",{class:e.fa_icon})])])})),0)};function d(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function u(t){for(var e,i=1;i<arguments.length;i++)e=null==arguments[i]?{}:arguments[i],i%2?d(Object(e),!0).forEach((function(i){f(t,i,e[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):d(Object(e)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(e,i))}));return t}function f(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}c._withStripped=!0;var p={name:"AgentTypeField",extends:i(12).a,computed:u(u({},Object(a.e)(["controlledLists"])),{},{options:function(){return this.controlledLists.agentTypes}}),methods:{optionId:function(t){return"agent-type-option-"+t+this.fieldId}}},_=i(1),h=Object(_.a)(p,c,[],!1,null,null,null);h.options.__file="src/components/fields/AgentTypeField.vue";var v=h.exports,m=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("div",{staticClass:"attribution-field-validated",class:t.classes},[i("label",{attrs:{for:t.fieldId}},[t._t("default")],2),t._v(" "),i("input",{directives:[{name:"model",rawName:"v-model",value:t.textValue,expression:"textValue"}],staticClass:"form-control",class:{"form-control-invalid":t.failed},attrs:{type:"text",id:t.fieldId,placeholder:t.placeholder},domProps:{value:t.textValue},on:{input:[function(e){e.target.composing||(t.textValue=e.target.value)},t.debouncedSetValue]}}),t._v(" "),i("i",{staticClass:"box-status-icon fas",class:t.boxIcon,attrs:{title:t.failed},on:{click:function(e){return t.$emit("cancel")}}})])};m._withStripped=!0;var b=i(32),g=i(17),y=i.n(g),x={name:"ValidatedField",extends:b.a,props:{validator:Function},data:function(){return{failed:!1,loading:!1,typing:!1,textValue:null}},computed:{boxIcon:function(){return this.failed?"fa-times":this.loading?"fa-spinner fa-spin":this.typing?"fa-xs fa-ellipsis-h":"fa-check"}},methods:{validate:function(){var t=this;this.loading=!0,this.failed=null,this.validator(this.textValue).then((function(e){t.$emit("input",e),t.textValue=e})).catch((function(e){t.failed=e,t.$emit("input",null)})).finally((function(){t.loading=!1}))}},created:function(){this.debouncedSetValue=y()(this.validate,500),this.textValue=this.value},watch:{value:function(t){t&&!this.loading&&(this.textValue=t)},loading:function(t){!t&&this.value!==this.textValue&&this.value&&(this.textValue=this.value)}}},O=Object(_.a)(x,m,[],!1,null,null,null);O.options.__file="src/components/fields/ValidatedField.vue";var w=O.exports;function j(t,e){var i=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),i.push.apply(i,n)}return i}function C(t){for(var e,i=1;i<arguments.length;i++)e=null==arguments[i]?{}:arguments[i],i%2?j(Object(e),!0).forEach((function(i){k(t,i,e[i])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(e)):j(Object(e)).forEach((function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(e,i))}));return t}function k(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var I={name:"EditAgent",extends:o.a,components:{AgentTypeField:v,ValidatedField:w},props:{canSave:{default:function(){return!0}}},data:function(){return{edits:{},affiliations:[],expand:!1,userOptions:[],affiliationOptions:[],syncing:!1,idValidation:{failed:null,loading:!1}}},computed:C(C({},Object(a.e)(["canEdit","packageId","controlledLists"])),{},{contributor:function(){return l.c.query().with("meta").with("affiliations.other_agent").with("affiliations.meta").find(this.contributorId)},displayName:function(){return"person"===this.edits.agent_type?this.edits.given_names_first?[this.edits.given_names,this.edits.family_name].join(" "):[this.edits.family_name,this.edits.given_names].join(" "):this.edits.name},idGen:function(){return[Object(r.a)(8)]},isValid:function(){var t,e=function(t){return null==t||""===t.trim()};return t="person"===this.edits.agent_type?!e(this.edits.family_name)&&!e(this.edits.given_names):!e(this.edits.name),this.canSave&&t}}),methods:C(C({},Object(a.b)(["removeContributor"])),{},{refresh:function(){var t=this;if(this.edits=this.contributor.getCopy(),this.affiliations=this.contributor.affiliations.filter((function(t){return!t.meta.to_delete})).map((function(t){return{label:t.other_agent.displayName,value:t.other_agent_id,record:t.other_agent}})),this.edits.agent_type||this.edits.external_id_scheme||this.$set(this.edits,"agent_type",Object.keys(this.controlledLists.agentTypes)[0]),!this.edits.agent_type&&this.edits.external_id_scheme){var e=Object.entries(this.controlledLists.agentTypes).filter((function(e){return e[1].default===t.edits.external_id_scheme}));0<e.length&&this.$set(this.edits,"agent_type",e[0][0])}this.edits.external_id_scheme||this.$set(this.edits,"external_id_scheme",this.controlledLists.agentTypes[this.edits.agent_type].default_scheme),void 0===this.edits.given_names_first&&this.$set(this.edits,"given_names_first",!0),this.edits.user_id&&Object(s.b)("user_show",{id:this.edits.user_id}).then((function(e){t.userOptions=[{label:e.display_name,value:t.edits.user_id}]}))},saveChanges:function(){var t=this;if(this.isValid){var e=[];this.$refs.externalId.failed&&(this.edits.external_id=null);var i=this.affiliations.filter((function(e){return-1===t.contributor.affiliations.findIndex((function(t){return t.other_agent_id===e.value}))})).map((function(i){var n={agent_id:t.contributorId,other_agent_id:i.value,package_id:t.packageId,meta:{is_new:!0,is_temporary:t.contributor.is_temporary}};return l.c.query().where("id",i.value).exists()||(i.record.meta={is_new:!0},e.push(l.c.insert({data:i.record}))),n}));return e.push(l.b.insert({data:i})),this.contributor.affiliations.filter((function(e){return-1===t.affiliations.findIndex((function(t){return t.value===e.other_agent_id}))})).forEach((function(t){e.push(l.b.updateMeta(t.id,{to_delete:!0}))})),e.push(l.c.update({where:this.contributorId,data:this.edits})),Promise.all(e).then((function(){return l.c.updateMeta(t.contributorId,{is_dirty:!0})})).then((function(){t.stopEdit()})).catch((function(t){return console.error(t)}))}},stopEdit:function(){l.c.updateMeta(this.contributorId,{is_editing:!1})},syncAgent:function(){var t=this;Object(s.b)("agent_external_read",{external_id:this.edits.external_id,external_id_scheme:this.edits.external_id_scheme}).then((function(e){Object.entries(e).forEach((function(e){t.edits[e[0]]=e[1]}))}))},updateAffiliationOptions:function(t){var e=this,i=l.c.query().where("isActive",!0).where((function(t){return t.id!==e.contributorId})).where((function(t){return-1===e.affiliations.findIndex((function(e){return e.value===t.id}))}));t&&""!==t&&(i=i.where((function(e){var i=t.toLowerCase(),n=!!e.family_name&&e.family_name.toLowerCase().startsWith(i),a=!!e.given_names&&e.given_names.toLowerCase().startsWith(i),s=!!e.name&&e.name.toLowerCase().startsWith(i);return n||a||s}))),this.affiliationOptions=i.get().map((function(t){return{label:t.displayName,value:t.id,record:t}}))},updateUserOptions:function(t){var e=this;return""===t||null===t?void(this.userOptions=[]):void Object(s.b)("user_list",{q:t}).then((function(t){e.userOptions=t.map((function(t){return{label:t.display_name,value:t.id}}))}))},validateExternalId:function(t){return t?Object(s.c)("validate_external_id",{external_id:t,external_id_scheme:this.edits.external_id_scheme},"validateExternalId").then((function(t){if(t.id)return t.id;throw new Error(t.error||"Not valid")})):new Promise((function(t){t(null)}))}}),created:function(){var t=this;this.refresh(),this.expand=!this.isValid,this.eventBus.$on(this.events.saveAgent,(function(e){e===t.contributorId&&t.saveChanges()}))},watch:{isValid:function(t){this.$emit("validated",t)}}},$=Object(_.a)(I,n,[],!1,null,null,null);$.options.__file="src/components/EditAgent.vue";e.default=$.exports}}]);